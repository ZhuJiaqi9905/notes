[TOC]



# shell脚本

- Shell是命令解释器，用于解释用户对操作系统的操作

- Shell有很多。Centos 7默认使用的Shell是bash

## Linux启动过程

BIOS引导

MBR(主引导记录部分)

- 用`dd if=/dev/sda of=mbr.bin bs=446 count=1` , `hexdump -C mbr.bin`查看引导记录部分。

BootLoader(grub)

```shell
cd /boot/grub2
grub2-editenv list
```

kernel

systemd

系统初始化

shell

## 脚本前置知识

- UNIX的哲学：一条命令只做一件事
- 为了组合命令和多次执行，使用脚本文件来保存需要的指令
- 赋予文件执行权限`chmod  u+rx filename`

- 编写bash脚本的最前面加入声明，又称为Sha-Bang

```shell
#!/bin/bash
cd /usr/
ls
```

- 运行bash脚本：
  - `bash  filename.sh`：
    - 使用bash运行
    - 可以没有可执行权限
    - 在新的子进程下运行
  - `./filename.sh`：
    - 系统使用当前的shell来运行，如果最前面加入了声明，就使用bash来运行
    - 需要有可执行权限
    - 在新的子进程下运行
  - `source ./filename.sh`：
    - 在当前进程运行脚本
  - `. filename.sh`：
    - 在当前进程运行脚本

- 内建命令不需要创建子进程
- 内建命令对当前Shell生效

## 管道与重定向

### 管道

- 管道和信号一样，是进程通信对方式之一
- 匿名管道（管道符）是Shell编程中常用的通信工具
- 管道符`|`，将前一个命令执行结果传递给后一个命令
- 如果管道符两端的命令是外部命令，会分别创建子进程。管道符将左端输出和右端输入相连

### 重定向

- 一个进程默认会打开标准输入、标准输出、错误输出三个文件描述符
- 输入重定向`<`
  - `read var < path/to/a/file`
- 输出重定向`>`, `>>`, `2>`, `&>`
  - `>` ：把原内容清空再写
  - `>>`：写追加
  - `2>`：把错误输出到指定文件
  - `&>`：不管正确还是错误，都输出到指定文件
- 输入与输出重定向组合使用

## 变量

### 变量的定义

- 命名规则
  - 字母、数字、下划线
  - 不以数字开头
- 如果变量名有重复，后定义的会覆盖掉之前定义的

### 变量的赋值

- `变量名=变量值`
  - 等号左右不允许出现空格
- 用let为变量赋值：`let a = 10+20`	
  - 实际写shell脚本尽量避免计算，因为性能低
- 将命令赋值给变量：`l=ls`
- 将命令结果赋值给变量，使用$()或者``
  - `letc=$(ls -l /etc)`
- 变量值有空格等特殊字符，可以包含在" "或' '中

### 变量的引用

- `${变量名}`称为对变量的引用
- 查看变量值：`echo ${var}`
- 在部分情况下`${变量名}`可以省略成`$变量名`

### 变量的作用范围

- 变量的默认作用范围：只有当前的shell，不包括父子shell
- 变量的导出：让子进程得到父进程的变量
  - `export 变量名=变量值`
  - `export 变量名` （如果之前已经定义了变量）
- 变量的删除：`unset 变量名`

### 系统环境变量

- 环境变量：每个shell打开都可以获得到的变量
  - set和env命令查看环境变量：`env | more`
  - 预定义变量：
    - `$? `：上一条命令是否产生错误。0表示无错
    - `$$`：显示当前进程的pid
    - `$0`：显示当前进程名称
  - `$PATH`：每个路径用`:`分隔
  - `$PS1`：是当前的提示终端的变量
- 位置变量
  - 用来表示命令行参数的每个位置的参数
  - `$1 $2 ... $9 ${10} ${11}` 
  - `${n-_}`：如果`${n}`是空的，就读入`_`

### 环境变量配置文件

- 配置文件
  - `/etc/profile`
  - `/etc/profile.d/`: 是一个目录，根据不同shell类型来执行不同脚本
  - `/etc/bashrc`
  - `~/.bash_profile`
  - `~/.bashrc`

login shell：用`su -用户名`登陆：

- 加载`/etc/profile`
- 加载`~/.bash_profile`
- 加载`~/.bashrc`
- 加载`/etc/bashrc`

no login shell：用`su 用户名`登陆：

- 加载`~/.bashrc`
- 加载`/etc/bashrc`

## 数组

### 数组定义和使用

- 定义数组：`IPTS=(10.0.0.1 10.0.0.2 10.0.0.3)`
- 显示数组的所有元素 `echo ${IPTS[@]}`
- 显示数组元素个数：`echo ${#IPTS[@]}`
- 显示数组第一个元素：`echo ${IPTS[0]}`

## 符号与运算

### 转义与引用

- 特殊字符
  - `#`：注释
  - `;`：分号
  - `\`：转义符号
  - `""`, `''`：引号
- 转义符号：
  - `\n \r \t`
  - `\$ \" \\`
- 引用
  - `"`： `echo "$var"` 会显示`var`的值
  - `'`：`echo '$var'`会显示`var`
  - `：

### 运算符

- 赋值运算符：`=`
  - 使用unset取消为变量的赋值
  - `=`还可以作为测试运算符
- 算术运算符
  - 基本运算符：`+ - * / ** %`
  - 使用expr进行运算：`expr 1 + 2`
    - 只能用在整数
    - 符号和数字之间要有空格

- 数字常量
  - `let "变量名 = 变量值"`
  - 变量值使用0开头是八进制
  - 变量值使用0x开头是十六进制
- 双圆括号
  - 是let命令的简化
  - `((a = 10+1))`
  - ` ((a++))`
  - `echo $((10+20))`



