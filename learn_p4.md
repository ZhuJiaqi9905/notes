# P4



## P4简介

参考：

https://www.sdnlab.com/17795.html

https://www.sdnlab.com/17882.html

### 架构及特性

P4的设计为了实现以下三个特性：

- 协议无关性

网络设备不予任何特定协议绑定。用户可以自定义数据平面的协议和数据包的处理行为。这一特性通过**自定义包解析器、匹配-动作表的匹配流程和流控制程序**实现。

- 目标无关性

用户不需关心底层硬件的实现细节。这一特性通过P4前后端编译器实现。前端编译器将P4高级语言转换成中间表示IR，后端编译器将IR编译成设备配置，自动配置目标设备

- 可重构性

允许用户随时改变包解析和处理的程序，并在编译后配置交换机。这一特性通过P4交换机的模块化设计来实现。各个模块的输入输出都采用标准格式的配置文件。

## 交换机结构

P4交换机中也有流水线（pipeline）的概念，一条流水线表示一组完整的数据处理流程。它可以包含以下组件：解析器/逆解析器、匹配-动作表、元数据总线。其中除了元数据总线，其他组件都是非必须的。

- 解析器(parser)/逆解析器(deparser)：进行分组数据和元数据的相互转化
- 匹配-动作表(match-action table)：操作元数据
- 元数据(metadata)：在流水线内存储数据信息

P4交换机将数据处理单元对数据的处理抽象成匹配和执行匹配-动作表的过程；包头的解析抽象成解析器；数据处理流程抽象成流控制。

P4中基础数据处理单元是不记录数据的，所以就需要引入一个元数据总线，用来存储一条流水线处理过程中需要记录的数据。

P4交换机含有两条流水线——入口流水线和出口流水线。同时还有一些数据流管理功能，如：拥塞控制、队列控制、流量复制等。

### 工作流程

- 用户自定义数据帧的解析器和流控制程序
- 编译P4程序，输出JSON格式的交换机配置文件和运行时API
- 配置文件载入交换机，更新解析器和匹配-动作表
- 交换机操作系统按照流控制程序进行包的查表操作

### 项目简介

P4项目源码：https://github.com/p4lang  其中的每个模块都是一个子项目。下面分别介绍一下：

- behavioral-model

简称是bmv2，是模拟P4数据平面的用户态软件交换机。P4程序会先经过p4c-bm模块编译成JSON格式的配置文件，然后将配置文件载入到bmv2。转化成能实现交换机功能的代码。

- p4-hlir

前端编译器。使得后端编译器开发者能从语法分析和目标无关的语义检查的负担中解放。

- p4c-bm

后端编译器。输出一个可以载入到behavioral model的JSON配置文件。

- p4-build

需要手动生成的基础设施库，为执行P4程序编译、安装PD库。

- switch

一个switch.p4样例。可独立于p4factory运行

- ntf

网络测试框架。含有用以执行bmv2上应用的网络测试样例。该框架中集成了mininet和docker，方便用户进行测试。

- p4factory

内含整套用以运行和开发基于behavioral model的P4程序环境的代码，帮助用户快速开发P4程序。

这个项目已经废弃了。

- ptf

数据平面测试框架

- scapy-vxlan

基于Scapy项目，barefoot对其进行了定制，支持更多协议的数据包包头的伪造和解析，目前支持 VXLAN和ERSPAN-like（Scapy本身并不支持）。

- tutorials

## 软件安装

参考：

https://www.sdnlab.com/19912.html

## P4编程 tutorial

参考

https://github.com/p4lang/tutorials

https://www.sdnlab.com/17882.html