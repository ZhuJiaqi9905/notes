# 链接，装载，库

## 编译和链接

`gcc hello.c`的4个步骤：

- 预处理(preprocessing)
- 编译(compilation)
- 汇编(assembly)
- 链接（linking)

### 预编译

预编译会生成`.i`文件，其过程相当于: `gcc -E hello.c -o hello.i`

- 将所有的`#define`删除，并展开宏定义
- 处理所有的条件预编译指令，`#if`等
- 处理`#include`预编译指令，递归地插入包含的文件
- 删除注释
- 添加行号和文件名标识，比如`#2 "hello.c" 2`，以便编译时编译器产生调试用的行号信息，和用于编译时产生编译错误或警告时显示行号
- 保留所有的`#pragma`编译器指令

### 编译

通过词法分析、语法分析、语义分析、语义分析及优化后产生相应的汇编代码文件。

其过程相当于`gcc -S hello.i -o hello.s`

现代版本的GCC把预编译和编译合成一个步骤，使用一个名为`cc1`的程序完成这两个步骤。例如在我的WSL中输入：`/usr/lib/gcc/x86_64-linux-gnu/9/cc1 hello.c`。对于C++来说，其对应的程序是`cc1plus`。

gcc命令只是上述程序的包装，它会根据不同的参数去调用预编译编译程序`cc1`，汇编器`os`，链接器`ld`。

### 汇编

将汇编代码转变成可执行的指令。生成`.o`可执行文件。

其过程为`gcc -c hello.s -o hello.o`，或`as hello.s -o hello.o`。

### 链接

将多个文件链接起来，生成最终的可执行文件。

定义其他模块的全局变量和函数在最终运行时的绝对地址都要在最终链接的时候才能确定。

主要包括：

- 地址和空间分配(Address and Storage Allocation)
- 符号决议(Symbol Resolution)
- 重定位(Relocation)

我们将**中间目标文件**简称为**目标文件**。很多时候也把目标文件称为**模块**。

